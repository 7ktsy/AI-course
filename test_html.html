<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>知识图谱可视化</title>
  <script src="https://unpkg.com/cytoscape@3.24.0/dist/cytoscape.min.js"></script>
  <style>
    #cy {
      width: 100%;
      height: 95vh;
      display: block;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>

<h2 style="text-align:center;">知识图谱可视化 (Cytoscape.js)</h2>
<div style="text-align: center; margin: 10px;">
  <input type="text" id="searchInput" placeholder="搜索节点..." style="padding: 5px; margin: 5px;">
  <button onclick="filterNodes()">搜索</button>
  <button onclick="showAll()">显示全部</button>
  <select id="nodeCount" onchange="limitNodes()">
    <option value="10">显示前10个</option>
    <option value="20" selected>显示前20个</option>
    <option value="50">显示前50个</option>
    <option value="100">显示前100个</option>
  </select>
</div>
<div id="cy"></div>

<script>
let originalData = null;
let cy = null;

// 加载外部的 JSON 数据
fetch('cytoscape_graph.json')
  .then(response => response.json())
  .then(graphData => {
    originalData = graphData;
    initializeGraph(20); // 默认显示前20个
  });

function initializeGraph(limit) {
  if (!originalData) return;
  
  // 统计节点连接数
  const nodeConnections = {};
  originalData.edges.forEach(edge => {
    const source = edge.data.source;
    const target = edge.data.target;
    nodeConnections[source] = (nodeConnections[source] || 0) + 1;
    nodeConnections[target] = (nodeConnections[target] || 0) + 1;
  });
  
  // 获取前N个最重要的节点
  const topNodes = Object.entries(nodeConnections)
    .sort(([,a], [,b]) => b - a)
    .slice(0, limit)
    .map(([nodeId]) => nodeId);
  
  // 过滤数据
  const filteredNodes = originalData.nodes.filter(node => 
    topNodes.includes(node.data.id)
  );
  
  const filteredEdges = originalData.edges.filter(edge => 
    topNodes.includes(edge.data.source) && topNodes.includes(edge.data.target)
  );
  
  // 销毁现有图谱
  if (cy) cy.destroy();
  
  cy = cytoscape({
    container: document.getElementById('cy'),
    elements: [...filteredNodes, ...filteredEdges],
    layout: {
      name: 'cose',
      animate: true,
      nodeRepulsion: 400000,
      nodeOverlap: 10,
      idealEdgeLength: 100,
      edgeElasticity: 100
    },
    style: [
      // 通用默认样式 - 放在最前面
      {
        selector: 'node',
        style: {
          'label': 'data(id)',
          'background-color': '#01FF70',
          'text-valign': 'center',
          'color': '#fff',
          'font-size': '12px',
          'text-outline-width': 2,
          'text-outline-color': '#01FF70',
          'width': 'mapData(connections, 0, 50, 30, 80)',
          'height': 'mapData(connections, 0, 50, 30, 80)'
        }
      },
      // CATEGORY类型 - 蓝色
      {
        selector: 'node[label = "CATEGORY"]',
        style: {
          'label': 'data(id)',
          'background-color': '#0074D9',
          'text-valign': 'center',
          'color': '#fff',
          'font-size': '12px',
          'text-outline-width': 2,
          'text-outline-color': '#0074D9',
          'width': 'mapData(connections, 0, 50, 30, 80)',
          'height': 'mapData(connections, 0, 50, 30, 80)'
        }
      },
      // EVENT类型 - 红色
      {
        selector: 'node[label = "EVENT"]',
        style: {
          'label': 'data(id)',
          'background-color': '#FF4136',
          'text-valign': 'center',
          'color': '#fff',
          'font-size': '12px',
          'text-outline-width': 2,
          'text-outline-color': '#FF4136',
          'width': 'mapData(connections, 0, 50, 30, 80)',
          'height': 'mapData(connections, 0, 50, 30, 80)'
        }
      },
      // ORGANIZATION类型 - 绿色
      {
        selector: 'node[label = "ORGANIZATION"]',
        style: {
          'label': 'data(id)',
          'background-color': '#2ECC40',
          'text-valign': 'center',
          'color': '#fff',
          'font-size': '12px',
          'text-outline-width': 2,
          'text-outline-color': '#2ECC40',
          'width': 'mapData(connections, 0, 50, 30, 80)',
          'height': 'mapData(connections, 0, 50, 30, 80)'
        }
      },
      // PERSON类型 - 橙色
      {
        selector: 'node[label = "PERSON"]',
        style: {
          'label': 'data(id)',
          'background-color': '#FF851B',
          'text-valign': 'center',
          'color': '#fff',
          'font-size': '12px',
          'text-outline-width': 2,
          'text-outline-color': '#FF851B',
          'width': 'mapData(connections, 0, 50, 30, 80)',
          'height': 'mapData(connections, 0, 50, 30, 80)'
        }
      },
      // GEO类型 - 紫色
      {
        selector: 'node[label = "GEO"]',
        style: {
          'label': 'data(id)',
          'background-color': '#B10DC9',
          'text-valign': 'center',
          'color': '#fff',
          'font-size': '12px',
          'text-outline-width': 2,
          'text-outline-color': '#B10DC9',
          'width': 'mapData(connections, 0, 50, 30, 80)',
          'height': 'mapData(connections, 0, 50, 30, 80)'
        }
      },
      // Unknown类型 - 灰色
      {
        selector: 'node[label = "Unknown"]',
        style: {
          'label': 'data(id)',
          'background-color': '#AAAAAA',
          'text-valign': 'center',
          'color': '#fff',
          'font-size': '12px',
          'text-outline-width': 2,
          'text-outline-color': '#AAAAAA',
          'width': 'mapData(connections, 0, 50, 25, 70)',
          'height': 'mapData(connections, 0, 50, 25, 70)'
        }
      },
      // 边的样式
      {
        selector: 'edge',
        style: {
          'width': 'mapData(weight, 1, 50, 1, 3)',
          'line-color': '#ddd',
          'target-arrow-shape': 'triangle',
          'target-arrow-color': '#ddd',
          'curve-style': 'bezier',
          'opacity': 0.6
        }
      }
    ]
  });

  // 为节点添加连接数信息（用于大小映射）
  cy.nodes().forEach(node => {
    const connections = nodeConnections[node.id()] || 0;
    node.data('connections', connections);
  });
  
  // 添加点击事件，显示节点详细信息
  cy.on('tap', 'node', function(evt) {
    const node = evt.target;
    console.log('节点信息:', {
      id: node.data('id'),
      label: node.data('label'),
      connections: node.data('connections')
    });
  });
}

function limitNodes() {
  const limit = parseInt(document.getElementById('nodeCount').value);
  initializeGraph(limit);
}

function filterNodes() {
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  if (!searchTerm) return;
  
  cy.nodes().hide();
  cy.edges().hide();
  
  const matchingNodes = cy.nodes().filter(node => 
    node.data('id').toLowerCase().includes(searchTerm)
  );
  
  matchingNodes.show();
  matchingNodes.connectedEdges().show();
}

function showAll() {
  cy.nodes().show();
  cy.edges().show();
  document.getElementById('searchInput').value = '';
}
</script>

</body>
</html>
